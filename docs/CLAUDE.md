# Package: docs

**Location:** `docs/`
**Type:** Standalone Astro 5 + Starlight documentation website
**Dependencies:** Astro, Starlight, React, Tailwind CSS, Mermaid CLI, pnpm

---

## Purpose & Responsibility

### Owns

- Saturn engine documentation website (deployed to GitHub Pages)
- Content authoring in MDX (Markdown + JSX for React components)
- Multi-language support (English, Italian via Starlight i18n)
- Mermaid diagram pre-rendering workflow (dual-theme SVG generation)
- Custom React components for documentation (`MermaidDiagram`, future interactive demos)
- Site configuration (sidebar, navigation, plugins, theming)
- Build pipeline (Mermaid sync â†’ Astro build â†’ static site generation)
- SEO metadata (sitemap, robots.txt, Open Graph tags)

### Does NOT Own

- C++ code documentation generation (docsgen/ package)
- API reference extraction (codex/ package)
- Engine architecture or implementation (saturn/, pieces/, codex/)
- Version control of generated assets (src/assets/mmds/\*.svg excluded from git)

---

## Key Abstractions & Invariants

### Core Technologies

- **Astro 5** (`astro.config.mjs:21`) â€” Static site framework with island architecture
- **Starlight** (`@astrojs/starlight`) â€” Documentation theme with built-in i18n, sidebar, search
- **React 19** â€” Component framework for interactive elements (MermaidDiagram)
- **TypeScript** (`tsconfig.json`) â€” Type-safe configuration and components
- **Tailwind CSS** (via `@astrojs/starlight-tailwind`) â€” Utility-first styling
- **Mermaid CLI** (`@mermaid-js/mermaid-cli`) â€” Pre-rendering diagrams to SVG

### Directory Structure

```
docs/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ content/
â”‚   â”‚   â”œâ”€â”€ docs/          # MDX content files
â”‚   â”‚   â”‚   â”œâ”€â”€ intro/     # Introduction pages
â”‚   â”‚   â”‚   â”œâ”€â”€ user/      # User guides
â”‚   â”‚   â”‚   â”œâ”€â”€ collaborator/  # Contributor guides
â”‚   â”‚   â”‚   â”œâ”€â”€ engineering/   # Design patterns/architecture
â”‚   â”‚   â”‚   â””â”€â”€ reference/ # API docs (autogenerated - future)
â”‚   â”‚   â””â”€â”€ i18n/          # Translation strings (it.json)
â”‚   â”œâ”€â”€ components/        # React components (MermaidDiagram.tsx)
â”‚   â”œâ”€â”€ mmds/              # Source Mermaid diagrams (*.mmd)
â”‚   â”œâ”€â”€ assets/            # Generated assets (gitignored)
â”‚   â”‚   â””â”€â”€ mmds/          # Pre-rendered SVGs (*_light.svg, *_dark.svg)
â”‚   â””â”€â”€ content.config.ts  # Content collections schema
â”œâ”€â”€ public/                # Static assets (favicon.svg, robots.txt)
â”œâ”€â”€ dist/                  # Build output (gitignored)
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ sync_mermaid.mjs   # Pre-rendering workflow
â”œâ”€â”€ astro.config.mjs       # Astro + Starlight configuration
â”œâ”€â”€ package.json           # pnpm scripts and dependencies
â”œâ”€â”€ puppeteer-config.json  # Headless Chrome config for mmdc
â””â”€â”€ tsconfig.json          # TypeScript config (React JSX)
```

### Invariants (NEVER violate)

1. **Mermaid pre-rendering**: ALL Mermaid diagrams MUST be pre-rendered to SVG (dual-theme) before build
2. **Theme synchronization**: MermaidDiagram component MUST watch `data-theme` attribute on `<html>` element
3. **i18n structure**: Translated pages MUST match English slug structure (`en: intro/overview` â†’ `it: intro/overview`)
4. **Sidebar autogeneration**: `engineering/` and `reference/` directories use autogenerate, manual changes forbidden
5. **Base URL**: Site MUST use `/saturn/` base (GitHub Pages subdirectory deployment)
6. **Content collections**: MDX files MUST be in `src/content/docs/` (Starlight requirement)
7. **Asset paths**: Component imports from `src/assets/` MUST use `/src/assets/` absolute path (Astro resolution)
8. **SVG cleanup**: Orphaned SVGs (no matching .mmd) MUST be deleted by sync_mermaid.mjs
9. **pnpm only**: MUST use pnpm (not npm/yarn) for dependency management
10. **Frontmatter required**: ALL MDX files MUST have `title` and `description` in frontmatter

### Architectural Patterns

- **Island Architecture**: Astro ships zero JS by default, React components hydrate on client only when needed
- **Content Collections**: Type-safe content via Astro's `defineCollection` + Starlight schemas
- **Pre-rendering workflow**: Mermaid â†’ mmdc â†’ dual-theme SVG â†’ React component â†’ theme-aware display
- **Plugin-based theming**: `starlight-theme-black` overrides default Starlight theme
- **Incremental builds**: sync_mermaid.mjs only regenerates SVGs if .mmd file newer than existing SVG

---

## Architectural Constraints

### Dependency Rules

**Allowed:**

- Astro official integrations (`@astrojs/react`, `@astrojs/sitemap`, `@astrojs/starlight`)
- Starlight plugins (`starlight-theme-black`, `starlight-kbd`, `starlight-scroll-to-top`)
- React 19 (components only, no routing/state management libraries)
- Tailwind CSS (via `@astrojs/starlight-tailwind`)
- Mermaid CLI (dev dependency for pre-rendering only)
- Type utilities (`@types/node`, `@types/react`, `@types/react-dom`)

**Forbidden:**

- âŒ Client-side Mermaid rendering (use pre-rendered SVGs only)
- âŒ Vue, Svelte, Solid (Astro supports them, but this project uses React exclusively)
- âŒ CSS-in-JS libraries (use Tailwind utility classes)
- âŒ Heavy client-side frameworks (Next.js, Remix, Gatsby)
- âŒ Runtime diagram generation (PlantUML abandoned for Mermaid pre-rendering)

### Build Workflow

**Development:**

```bash
pnpm run dev  # sync:mermaid â†’ astro dev (HMR on http://localhost:4321/saturn/)
```

**Production:**

```bash
pnpm run build  # sync:mermaid â†’ astro build â†’ dist/
```

**Preview:**

```bash
pnpm run preview  # Serve dist/ locally before deployment
```

### Threading Model

- **Build-time**: Node.js single-threaded (Astro bundler, Mermaid CLI via execSync)
- **Runtime**: Static HTML (zero JS by default, React islands hydrate independently)

### Lifetime & Ownership

- **Build artifacts**: `dist/` and `src/assets/mmds/` are ephemeral (gitignored, regenerated on build)
- **Source diagrams**: `src/mmds/*.mmd` are versioned (source of truth for diagrams)
- **Content**: `src/content/docs/**/*.mdx` are versioned (source of truth for documentation)
- **Translations**: `src/content/i18n/*.json` are versioned (i18n overrides)

### Platform Constraints

- **Deployment**: GitHub Pages (static hosting, `/saturn/` base path)
- **Node.js**: Requires Node.js 18+ (Astro 5 requirement)
- **pnpm**: Workspace-aware package manager (faster than npm, stricter than yarn)
- **Puppeteer**: Headless Chrome required for `mmdc` (Mermaid CLI dependency)

---

## Modification Rules

### Safe to Change

- Add new MDX files in `src/content/docs/` (follows Starlight conventions)
- Add new Mermaid diagrams in `src/mmds/` (auto-generated to SVG on next build)
- Extend `astro.config.mjs` sidebar (manual sections only, not autogenerate)
- Add new React components in `src/components/` (follow MermaidDiagram pattern)
- Update translations in `src/content/i18n/it.json`
- Add new Starlight plugins (test compatibility first)
- Improve `sync_mermaid.mjs` (incremental build logic, error handling)

### Requires Coordination

- Changing base URL (`/saturn/` â†’ something else) breaks GitHub Pages deployment
- Modifying MermaidDiagram component affects all diagrams across site
- Altering content collection schema impacts all MDX files
- Switching Starlight theme plugin requires CSS/Tailwind adjustments
- Changing i18n locales requires updating all translated content
- Modifying sidebar autogenerate directories breaks navigation

### Almost Never Change

- **Astro major version**: Upgrade with caution (breaking changes in SSR/SSG)
- **React JSX config**: `tsconfig.json` JSX settings are load-bearing for components
- **Content collections schema**: Breaks type-safety for all MDX files
- **Base path**: Hardcoded in astro.config.mjs, affects all links/assets
- **pnpm lockfile**: Only update via `pnpm install` (manual edits cause corruption)

---

## Common Pitfalls

### Footguns

- âš ï¸ **Forgetting sync:mermaid**: Running `astro dev` directly skips diagram generation (use `pnpm run dev`)
- âš ï¸ **Client-side Mermaid**: Importing `mermaid` library bloats bundle (pre-render to SVG instead)
- âš ï¸ **Hardcoded theme in SVG**: Using `<MermaidDiagram>` without dual-theme SVGs breaks dark mode
- âš ï¸ **Missing frontmatter**: MDX files without `title`/`description` cause build errors
- âš ï¸ **Incorrect asset paths**: `src="/assets/foo.svg"` fails (use `/src/assets/foo.svg` for Astro resolution)
- âš ï¸ **Sidebar autogenerate conflicts**: Manually adding items to `engineering/` autogenerate sections breaks navigation
- âš ï¸ **i18n slug mismatches**: Translated pages with different slugs break language switcher
- âš ï¸ **npm instead of pnpm**: Lockfile mismatch causes dependency resolution issues

### Performance Traps

- ğŸŒ **Large SVGs**: Mermaid diagrams with 100+ nodes bloat page size (split into multiple diagrams)
- ğŸŒ **Unoptimized images**: Use Astro's `<Image>` component for automatic optimization
- ğŸŒ **Too many React islands**: Excessive client-side hydration slows page load (use static HTML when possible)
- ğŸŒ **Uncached builds**: `pnpm run build` without cached `node_modules` takes 2-3 minutes (use CI cache)

### Historical Mistakes (Do NOT repeat)

- **PlantUML dependency**: Abandoned for Mermaid (better syntax, pre-rendering workflow)
- **Client-side Mermaid rendering**: Removed (100KB+ bundle size, layout shifts)
- **Manual SVG commits**: Removed (src/assets/mmds/ now gitignored, auto-generated)

---

## How Claude Should Help

### Expected Tasks

- Add new documentation pages in `src/content/docs/` (follow existing frontmatter pattern)
- Create Mermaid diagrams in `src/mmds/` (architecture diagrams, flowcharts)
- Update sidebar configuration in `astro.config.mjs` (manual sections only)
- Improve MermaidDiagram component (error handling, loading states)
- Add new React components for interactive examples (component showcase, API demos)
- Write translations in `src/content/i18n/it.json`
- Fix broken links, improve SEO metadata
- Optimize sync_mermaid.mjs (parallel processing, better error messages)

### Conservative Approach Required

- **Changing Astro/Starlight versions**: Test thoroughly (breaking changes common)
- **Modifying content collections schema**: Affects ALL MDX files (validate first)
- **Altering MermaidDiagram component**: Breaks ALL diagrams if not backward-compatible
- **Switching theme plugin**: Requires CSS/Tailwind audit (starlight-theme-black has custom styles)
- **Changing i18n structure**: Breaks language switcher (coordinate with translators)

### Before Making Changes

- [ ] Verify `pnpm run dev` works after modifications (catches config errors)
- [ ] Test both light/dark themes (MermaidDiagram component, theme-black plugin)
- [ ] Check i18n pages render correctly (language switcher, translated slugs)
- [ ] Run `pnpm run build` to catch static generation errors
- [ ] Preview `dist/` output with `pnpm run preview` before deployment
- [ ] Verify Mermaid diagrams render correctly (dual-theme SVGs generated)
- [ ] Test on mobile/tablet (Starlight responsive, but custom components may need adjustment)

---

## Quick Reference

### Files

**Configuration:**

- `astro.config.mjs` â€” Astro + Starlight config (sidebar, plugins, i18n)
- `package.json` â€” pnpm scripts (dev, build, preview, sync:mermaid)
- `tsconfig.json` â€” TypeScript config (React JSX)
- `puppeteer-config.json` â€” Headless Chrome config for mmdc

**Content:**

- `src/content/docs/**/*.mdx` â€” Documentation pages (MDX = Markdown + JSX)
- `src/content/i18n/it.json` â€” Italian translations
- `src/mmds/*.mmd` â€” Source Mermaid diagrams

**Components:**

- `src/components/mmd_diagram.tsx` â€” Theme-aware Mermaid diagram renderer

**Scripts:**

- `scripts/sync_mermaid.mjs` â€” Pre-render .mmd â†’ dual-theme SVG (light/dark)

**Build Artifacts (gitignored):**

- `dist/` â€” Static site output (HTML, CSS, JS)
- `src/assets/mmds/` â€” Pre-rendered SVGs (_\_light.svg, _\_dark.svg)

### Key Commands

- `pnpm run dev` â€” Start dev server with HMR (includes Mermaid sync)
- `pnpm run build` â€” Build static site for production
- `pnpm run preview` â€” Preview production build locally
- `pnpm run sync:mermaid` â€” Manually trigger Mermaid pre-rendering

### Starlight Plugins

- `starlight-theme-black` â€” Dark theme with custom styling
- `starlight-kbd` â€” Keyboard shortcut component (`<kbd>`)
- `starlight-scroll-to-top` â€” Scroll-to-top button

### Content Structure

- `intro/` â€” Introduction pages (overview)
- `user/` â€” User guides (getting started - WIP)
- `collaborator/` â€” Contributor guides (C++ conventions, GitHub conventions)
- `engineering/` â€” Design patterns (PIMPL, ABI safety, memory safety, compilation optimization)
- `reference/` â€” API reference (autogenerated - future, will be populated by docsgen)

---

## Status Notes

**Active development** â€” Website deployed to GitHub Pages. Mermaid pre-rendering workflow stable. API reference section pending integration with docsgen/codex output. Italian translations incomplete (only navigation strings, no content pages yet).
